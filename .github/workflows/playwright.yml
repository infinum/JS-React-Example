name: ğŸ­ Playwright E2E Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  e2e-tests:
    name: ğŸ§ª E2E Tests
    timeout-minutes: 60
    runs-on: ubuntu-22.04

    env:
      NODE_ENV: test
      NEXTAUTH_SECRET: 'test-secret-for-ci-only'
      NEXT_PUBLIC_EXAMPLE_VARIABLE: 'CI Test Variable'
      PRIVATE_EXAMPLE_VARIABLE: 'Private CI Test Variable'
      CI: true

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ’» Node setup
        uses: ./.github/actions/node-setup

      - name: ğŸ’¾ Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: ğŸ­ E2E Setup
        uses: ./.github/actions/e2e-setup
        with:
          browsers: 'chromium'

      - name: ğŸ—ï¸ Build Frontend App
        run: pnpm --filter @infinum/frontend build
        shell: bash

      - name: ğŸš€ Start Frontend App (Background)
        run: |
          echo "ğŸ”§ Environment variables:"
          echo "NODE_ENV: $NODE_ENV"
          echo "NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:0:10}..."
          echo ""
          echo "ğŸš€ Starting server..."
          node apps/frontend/.next/standalone/apps/frontend/server.js &
          SERVER_PID=$!
          echo "FRONTEND_PID=$SERVER_PID" >> $GITHUB_ENV
          echo "âœ… Server started with PID: $SERVER_PID"
          sleep 2
          echo "ğŸ“Š Server process status:"
          ps aux | grep $SERVER_PID || echo "âŒ Server process not found"
        shell: bash
        env:
          NODE_ENV: production
          NEXTAUTH_SECRET: 'test-secret-for-ci-only'
          NEXT_PUBLIC_EXAMPLE_VARIABLE: 'CI Test Variable'
          PRIVATE_EXAMPLE_VARIABLE: 'Private CI Test Variable'

      - name: â³ Wait for Frontend to be Ready
        run: |
          echo "â³ Waiting for frontend to start on http://localhost:3000..."
          ATTEMPT=0
          MAX_ATTEMPTS=20

          until curl -f http://localhost:3000 > /dev/null 2>&1; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "ğŸ”„ Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting for frontend..."

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Frontend failed to start after $MAX_ATTEMPTS attempts"
              echo "ğŸ“Š Current processes:"
              ps aux | grep -E "(node|next)" | grep -v grep
              echo "ğŸ” Checking port 3000:"
              netstat -tulpn | grep 3000 || echo "No process on port 3000"
              exit 1
            fi

            sleep 3
          done

          echo "âœ… Frontend is ready!"
        shell: bash

      - name: ğŸ” Detailed Health Check
        run: |
          echo "ğŸ¥ Running detailed health check..."
          echo "ğŸ“¡ HTTP response:"
          curl -f http://localhost:3000 -I | head -10
          echo ""
          echo "ğŸ“„ Basic page content:"
          curl -s http://localhost:3000 | head -20
          echo ""
          echo "ğŸ”— Testing login page:"
          curl -s http://localhost:3000/login | head -10 || echo "âŒ Login page not accessible"
          echo ""
          echo "âœ… Health check completed!"
        shell: bash

      - name: ğŸ§ª Run Playwright E2E Tests
        run: |
          echo "ğŸ¬ Starting Playwright E2E Tests..."
          echo "================================================"
          pnpm e2e
          echo "================================================"
          echo "âœ… E2E Tests completed!"

      - name: ğŸ›‘ Stop Frontend App
        shell: bash
        if: always()
        run: |
          if [ ! -z "$FRONTEND_PID" ]; then
            kill $FRONTEND_PID || true
          fi
